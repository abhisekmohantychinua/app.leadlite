import{Ga as m,Ha as b}from"./chunk-W6KZRV7D.js";import{S as u,X as f,f as i,ja as p,p as n,pc as y,z as c}from"./chunk-OHUCFFT6.js";var l=class o{hashPBKDF2Async(e,t){return i(this,null,function*(){let r=new TextEncoder,s=yield crypto.subtle.importKey("raw",r.encode(e),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),a=yield crypto.subtle.deriveBits({name:"PBKDF2",salt:r.encode(t),iterations:1e5,hash:"SHA-256"},s,256);return this.bufferToHex(a)})}bufferToHex(e){return[...new Uint8Array(e)].map(t=>t.toString(16).padStart(2,"0")).join("")}hashSHA256Async(e){return i(this,null,function*(){let r=new TextEncoder().encode(e),s=yield crypto.subtle.digest("SHA-256",r);return this.bufferToHex(s)})}static \u0275fac=function(t){return new(t||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};var g=class o{userDb;secretDb;cryptoService;constructor(){let e=f(b);this.userDb=e.users,this.secretDb=e.secrets,this.cryptoService=f(l)}createUser(e){return c(()=>n(this.createUserAsync(e)))}createUserAsync(e){return i(this,null,function*(){if(e.profile.size>3e5)throw new Error("Profile size should be less than 300kb");if((yield this.userDb.where("username").equals(e.username).count())>0)throw new Error("Username already exists");let r=m(),s=yield this.cryptoService.hashPBKDF2Async(e.password,r),a={id:m(),name:e.name,username:e.username,password:s,profile:e.profile,createdAt:new Date,lastModifiedAt:void 0},h={id:1,userSalt:r,sessionHash:void 0};return yield this.userDb.db.transaction("rw",this.userDb,this.secretDb,()=>this.userDb.clear().then(()=>this.secretDb.clear()).then(()=>this.userDb.add(a)).then(()=>this.secretDb.add(h))),a})}updateUser(e,t){return c(()=>n(this.updateUserAsync(e,t)))}updateUserAsync(e,t){return i(this,null,function*(){let r=yield this.userDb.where("username").equals(e).first();if(!r)throw new Error("User not found");if(t.name&&(r.name=t.name),t.profile){if(t.profile.size>3e5)throw new Error("Profile size should be less than 300kb");r.profile=t.profile}if(t.password){let a=m(),h=yield this.cryptoService.hashPBKDF2Async(t.password,a);r.password=h;let d=yield this.secretDb.get(1);if(!d)throw new Error("Salt not found");d.userSalt=a,yield this.secretDb.put(d)}if(r.lastModifiedAt=new Date,(yield this.userDb.update(r.id,r))===0)throw new Error("Failed to update user");return r})}loginUser(e,t){return c(()=>n(this.loginUserAsync(e,t)))}loginUserAsync(e,t){return i(this,null,function*(){let r=yield this.userDb.where("username").equals(e).first();if(!r)throw new Error("User not found");let s=yield this.secretDb.get(1);if(!s)throw new Error("Secret not found");if(!s.userSalt)throw new Error("User salt not found");let a=yield this.cryptoService.hashPBKDF2Async(t,s.userSalt);if(r.password!==a)throw new Error("Invalid password");let h=m(),d=yield this.cryptoService.hashSHA256Async(h);return s.sessionHash=d,yield this.secretDb.put(s),sessionStorage.removeItem("sessionKey"),sessionStorage.setItem("sessionKey",h),h})}logoutUser(){return c(()=>n(this.logoutUserAsync()))}logoutUserAsync(){return i(this,null,function*(){sessionStorage.removeItem("sessionKey");let e=yield this.secretDb.get(1);e&&(e.sessionHash=void 0,yield this.secretDb.put(e))})}hasExistingUser(){return c(()=>n(this.hasExistingUserAsync()))}getUser(){return c(()=>n(this.getUserAsync()))}validateSessionKey(e){return c(()=>n(this.validateSessionKeyAsync(e)))}hasExistingUserAsync(){return i(this,null,function*(){return(yield this.userDb.count())>0})}validateSessionKeyAsync(e){return i(this,null,function*(){if(!e)return!1;let t=yield this.secretDb.get(1);return t?.sessionHash?(yield this.cryptoService.hashSHA256Async(e))===t.sessionHash:!1})}getUserAsync(){return i(this,null,function*(){let e=yield this.userDb.toCollection().first();if(!e)throw new Error("User not found");return e})}static \u0275fac=function(t){return new(t||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};var v=class o{currentTheme=p("auto");getCurrentTheme(){return y(()=>this.currentTheme())}initTheme(){let e=localStorage.getItem("theme")||"auto",t=document.querySelector("html"),r;switch(e){case"light":r=!1,this.currentTheme.set("light");break;case"dark":r=!0,this.currentTheme.set("dark");break;case"system":r=window.matchMedia("(prefers-color-scheme: dark)").matches,this.currentTheme.set("system");break;default:{this.currentTheme.set("auto");let s=new Date().getHours();r=s<6||s>=18;break}}t&&(r?t.classList.add("dark"):t.classList.remove("dark")),localStorage.setItem("theme",e)}setTheme(e){localStorage.setItem("theme",e),this.initTheme()}static \u0275fac=function(t){return new(t||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};export{v as a,g as b};
